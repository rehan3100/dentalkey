workflows:
  ios-workflow:
    name: iOS Workflow
    environment:
      vars:
        KEYCHAIN_PASSWORD: Rehan@734266479
        CERTIFICATE_PASSWORD: Rehan@734266479
    scripts:
      - name: Debug Environment Variables
        script: |
          echo "Keychain Password Length: ${#KEYCHAIN_PASSWORD}"
          echo "Certificate Password Length: ${#CERTIFICATE_PASSWORD}"
      - name: Set up keychain and add certificates
        script: |
          echo "Initializing keychain..."
          security create-keychain -p $KEYCHAIN_PASSWORD /Users/builder/Library/codemagic-cli-tools/keychains/build.keychain
          security default-keychain -s /Users/builder/Library/codemagic-cli-tools/keychains/build.keychain
          security unlock-keychain -p $KEYCHAIN_PASSWORD /Users/builder/Library/codemagic-cli-tools/keychains/build.keychain
          security set-keychain-settings -lut 21600 /Users/builder/Library/codemagic-cli-tools/keychains/build.keychain

          echo "Importing certificates..."
          security import /Users/builder/Library/MobileDevice/Certificates/tmp8kl6noju.p12 -k /Users/builder/Library/codemagic-cli-tools/keychains/build.keychain -P $CERTIFICATE_PASSWORD -T /usr/bin/codesign || (echo "Failed to import certificate" && exit 1)

      - name: Build and code sign
        script: |
          echo "Building and signing the iOS app..."
          # Build the iOS app
          flutter build ios --release --no-codesign

          # Navigate to the iOS project directory
          cd ios

          # Archive the app
          xcodebuild archive \
            -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -archivePath $HOME/build/Runner.xcarchive \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="iPhone Distribution: 57MY2GPC32" \
            PROVISIONING_PROFILE_SPECIFIER="DentalKeyDistribute"

          # Export the archive to an IPA
          xcodebuild -exportArchive \
            -archivePath $HOME/build/Runner.xcarchive \
            -exportPath $HOME/build \
            -exportOptionsPlist ExportOptions.plist

      - name: Build artifact
        script: |
          # Move the generated IPA file to the artifacts directory
          mv $HOME/build/Runner.ipa $HOME/build/ios/Runner.ipa

    artifacts:
      - build/ios/Runner.ipa
